name: Daily Weather Notification

on:
  schedule:
    - cron: '0 0 * * *'

  workflow_dispatch:

jobs:
  send-weather:
    runs-on: ubuntu-latest
    steps:
      - name: Get current date
        run: echo "TODAY=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Fetch weather data (Beijing)
        run: |
          response=$(curl -s "https://api.open-meteo.com/v1/forecast?latitude=39.9042&longitude=116.4074&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia/Shanghai")
          echo "$response" > weather.json

          # æå–æ•°æ®
          max_temp=$(echo "$response" | jq -r '.daily.temperature_2m_max[0]')
          min_temp=$(echo "$response" | jq -r '.daily.temperature_2m_min[0]')
          wmo_code=$(echo "$response" | jq -r '.daily.weathercode[0]')

          # WMO å¤©æ°”ä»£ç è½¬ä¸­æ–‡ï¼ˆç®€åŒ–ç‰ˆï¼‰
          case $wmo_code in
            0) weather="æ™´" ;;
            1) weather="å¤šäº‘" ;;
            2) weather="é˜´" ;;
            3) weather="é˜´" ;;
            45|48) weather="é›¾" ;;
            51|53|55) weather="æ¯›æ¯›é›¨" ;;
            61|63|65) weather="å°é›¨" ;;
            66|67) weather="å†»é›¨" ;;
            71|73|75|77) weather="é›ª" ;;
            80|81|82) weather="é˜µé›¨" ;;
            85|86) weather="é˜µé›ª" ;;
            95|96|99) weather="é›·é˜µé›¨" ;;
            *) weather="æœªçŸ¥ ($wmo_code)" ;;
          esac

          echo "MAX_TEMP=$max_temp" >> $GITHUB_ENV
          echo "MIN_TEMP=$min_temp" >> $GITHUB_ENV
          echo "WEATHER=$weather" >> $GITHUB_ENV

      - name: Send to WeCom
        env:
          KEY: ${{ secrets.WEWORK_WEBHOOK_URL }}
        run: |
          if [ -z "$KEY" ]; then
            echo "æœªè®¾ç½® WEWORK_WEBHOOK_URLï¼Œè·³è¿‡æ¨é€"
            exit 0
          fi

          msg=$(cat <<EOF
{
  "msgtype": "markdown",
  "markdown": {
    "content": "ğŸŒ¤ï¸ **ä»Šæ—¥å¤©æ°”æé†’**\n\n- åŸå¸‚ï¼šåŒ—äº¬\n- æ—¥æœŸï¼š${{ env.TODAY }}\n- å¤©æ°”ï¼š${{ env.WEATHER }}\n- æ¸©åº¦ï¼š${{ env.MIN_TEMP }}Â°C ï½ ${{ env.MAX_TEMP }}Â°C\n\n> ç¥ä½ ä»Šå¤©æ„‰å¿«ï¼"
  }
}
EOF
          )

          curl -s -X POST \
            "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=$KEY" \
            -H "Content-Type: application/json" \
            -d "$msg" > /dev/null

          echo "âœ… å¤©æ°”æ¶ˆæ¯å·²æ¨é€è‡³ä¼ä¸šå¾®ä¿¡ç¾¤"


