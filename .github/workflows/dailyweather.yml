name: Daily Weather Notification

on:
  schedule:
    - cron: '0 0 * * *'  # UTC 00:00 = 北京时间 08:00
  workflow_dispatch:

jobs:
  send-weather:
    runs-on: ubuntu-latest
    steps:
      - name: Get current date
        run: echo "TODAY=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch weather data (Beijing)
        run: |
          response=$(curl -s "https://api.open-meteo.com/v1/forecast?latitude=39.9042&longitude=116.4074&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia/Shanghai")
          max_temp=$(echo "$response" | jq -r '.daily.temperature_2m_max[0]')
          min_temp=$(echo "$response" | jq -r '.daily.temperature_2m_min[0]')
          wmo_code=$(echo "$response" | jq -r '.daily.weathercode[0]')

          case $wmo_code in
            0) weather="晴" ;;
            1) weather="多云" ;;
            2|3) weather="阴" ;;
            45|48) weather="雾" ;;
            51|53|55) weather="毛毛雨" ;;
            61|63|65) weather="小雨" ;;
            66|67) weather="冻雨" ;;
            71|73|75|77) weather="雪" ;;
            80|81|82) weather="阵雨" ;;
            85|86) weather="阵雪" ;;
            95|96|99) weather="雷阵雨" ;;
            *) weather="未知 ($wmo_code)" ;;
          esac

          echo "MAX_TEMP=$max_temp" >> $GITHUB_ENV
          echo "MIN_TEMP=$min_temp" >> $GITHUB_ENV
          echo "WEATHER=$weather" >> $GITHUB_ENV

      - name: Send to WeCom
        env:
          KEY: ${{ secrets.WECOM_WEBHOOK_KEY }}
        run: |
          if [ -z "$KEY" ]; then
            echo "未设置 WECOM_WEBHOOK_KEY，跳过推送"
            exit 0
          fi

          # 构建 Markdown 消息（单行，用 \n 换行）
          content="🌤️ **今日天气提醒**\n\n- 城市：北京\n- 日期：${{ env.TODAY }}\n- 天气：${{ env.WEATHER }}\n- 温度：${{ env.MIN_TEMP }}°C ～ ${{ env.MAX_TEMP }}°C\n\n> 祝你今天愉快！"

          # 发送请求
          curl -s -X POST \
            "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=$KEY" \
            -H "Content-Type: application/json" \
            -d "{\"msgtype\": \"markdown\", \"markdown\": {\"content\": \"$content\"}}" \
            > /dev/null

          echo "✅ 天气消息已推送至企业微信群"
